# Data Retention Protocol

**Version:** 1.0.0
**Last Updated:** 2025-11-04
**Owner:** Infrastructure Team
**Status:** Active

---

## Purpose

This protocol defines how long different types of data are retained, when they should be archived or deleted, and the procedures for managing data lifecycle to optimize storage, meet compliance requirements, and preserve historical value.

## Scope

This protocol applies to all data generated by:
- System logs
- Application logs
- Backups (database and files)
- Reports and transcripts
- Conversation history
- Monitoring metrics
- Work files and temporary data
- Security audit trails

---

## Data Classification

### Critical Data (Permanent Retention)
**Definition:** Data essential for legal, compliance, or historical purposes

**Includes:**
- Security audit logs
- Financial/donation records
- Legal documents
- Policy documents
- Incident reports (P0/P1)
- Disaster recovery test results

**Retention:** Permanent (or per legal requirements)
**Storage:** `/home/dave/skippy/archive/critical/`
**Backup:** Yes, encrypted
**Review:** Annual

### Important Data (Long-term Retention)
**Definition:** Data valuable for analysis, troubleshooting, or reference

**Includes:**
- Deployment reports
- Conversation transcripts
- System health reports
- Performance baselines
- Configuration history
- Major incident reports (P2)

**Retention:** 2 years
**Storage:** `/home/dave/skippy/conversations/` → `/home/dave/skippy/archive/important/`
**Backup:** Yes
**Archive After:** 90 days
**Review:** Quarterly

### Operational Data (Medium-term Retention)
**Definition:** Data needed for active operations and recent troubleshooting

**Includes:**
- Application logs
- System logs
- Monitoring metrics
- Alert history
- Backup logs
- Test results

**Retention:** 90 days
**Storage:** `/home/dave/skippy/logs/` → `/home/dave/skippy/logs/archive/`
**Backup:** Optional
**Archive After:** 30 days
**Compress:** Yes

### Temporary Data (Short-term Retention)
**Definition:** Data needed for immediate operations only

**Includes:**
- Work files
- Temporary outputs
- Debug traces
- Cache files
- Session data

**Retention:** 7-30 days depending on type
**Storage:** `/home/dave/skippy/work/` or `/tmp/`
**Backup:** No
**Cleanup:** Automated

---

## Retention Schedules by Data Type

### System Logs

**Application Logs:**
- **Active:** 30 days uncompressed
- **Archived:** 60 days compressed
- **Total Retention:** 90 days
- **Location:** `/home/dave/skippy/logs/` → `/home/dave/skippy/logs/archive/`

**Security Logs:**
- **Active:** 90 days uncompressed
- **Archived:** 2 years compressed
- **Total Retention:** Permanent
- **Location:** `/home/dave/skippy/logs/security/`

**Monitoring Logs:**
- **Active:** 30 days
- **Aggregated:** 90 days
- **Summaries:** 1 year
- **Location:** `/home/dave/skippy/logs/aggregated/`

**Cleanup Commands:**
```bash
# Clean old logs (run weekly)
find /home/dave/skippy/logs -name "*.log" -mtime +30 -exec gzip {} \;
find /home/dave/skippy/logs/archive -name "*.gz" -mtime +90 -delete

# Security logs exception (keep longer)
find /home/dave/skippy/logs/security -name "*.log" -mtime +90 -exec gzip {} \;
# Never auto-delete security logs
```

### Backups

**Full System Backups:**
- **Frequency:** Weekly
- **Active Retention:** 4 weeks (4 backups)
- **Archived Retention:** 3 months (quarterly snapshots)
- **Location:** `/home/dave/skippy/backups/full/`
- **Size Management:** Keep last 4 weekly + last 3 monthly

**WordPress Backups:**
- **Frequency:** Daily
- **Active Retention:** 7 days (daily)
- **Weekly Retention:** 4 weeks
- **Monthly Retention:** 3 months
- **Location:** `/home/dave/skippy/backups/wordpress/`

**Database Backups:**
- **Frequency:** Daily
- **Active Retention:** 7 days
- **Archived Retention:** 30 days
- **Location:** `/home/dave/skippy/backups/database/`

**Cleanup Commands:**
```bash
# Keep last 7 daily backups
find /home/dave/skippy/backups/wordpress -name "wordpress_*.tar.gz" -mtime +7 -delete

# Keep last 4 weekly backups
find /home/dave/skippy/backups/full -name "full_*.tar.gz" -mtime +28 -delete

# Keep last 30 days of database backups
find /home/dave/skippy/backups/database -name "*.sql*" -mtime +30 -delete
```

### Reports and Documentation

**Session Transcripts:**
- **Active:** 90 days
- **Archived:** 2 years
- **Location:** `/home/dave/skippy/conversations/`
- **Compress After:** 90 days

**Deployment Reports:**
- **Active:** 90 days
- **Archived:** 1 year
- **Location:** `/home/dave/skippy/conversations/deployment_reports/`

**Security Reports:**
- **Active:** 1 year
- **Archived:** Permanent
- **Location:** `/home/dave/skippy/conversations/security_reports/`

**Performance Reports:**
- **Active:** 90 days
- **Archived:** 6 months
- **Location:** `/home/dave/skippy/conversations/performance_reports/`

**Cleanup Commands:**
```bash
# Archive old transcripts (compress after 90 days)
find /home/dave/skippy/conversations -name "*session*.md" -mtime +90 ! -name "*.gz" -exec gzip {} \;

# Delete old compressed transcripts (after 2 years)
find /home/dave/skippy/conversations -name "*session*.md.gz" -mtime +730 -delete
```

### Work Files

**Active Work Files:**
- **Retention:** 7 days
- **Location:** `/home/dave/skippy/work/active/`
- **Cleanup:** Automated daily

**Archived Work Files:**
- **Retention:** 30 days
- **Location:** `/home/dave/skippy/work/archive/`
- **Cleanup:** Automated weekly

**Upload Staging:**
- **Retention:** 30 days
- **Location:** `/home/dave/skippy/claude/uploads/`
- **Cleanup:** Manual review before deletion

**Cleanup Commands:**
```bash
# Use existing cleanup script
/home/dave/skippy/scripts/cleanup_work_files.sh

# Or manual cleanup
find /home/dave/skippy/work/active -type f -mtime +7 -delete
find /home/dave/skippy/work/archive -type f -mtime +30 -delete
```

### Monitoring Metrics

**Raw Metrics:**
- **Retention:** 30 days
- **Location:** `/home/dave/skippy/logs/metrics/`

**Aggregated Metrics:**
- **Retention:** 90 days
- **Location:** `/home/dave/skippy/logs/aggregated/`

**Historical Summaries:**
- **Retention:** 1 year
- **Location:** `/home/dave/skippy/logs/summaries/`

### Alert History

**Alert Logs:**
- **Active:** 90 days
- **Archived:** 1 year
- **Location:** `/home/dave/skippy/logs/alerts/`

**Alert Database:**
- **Retention:** 1 year
- **Location:** `/home/dave/skippy/logs/alerts/alert_history.json`

---

## Archival Procedures

### Manual Archive Process

**When to Archive:**
- Data older than active retention period
- Data no longer frequently accessed
- Before major cleanup operations
- End of campaign/project phases

**Archive Steps:**
1. Identify data to archive
2. Compress files (gzip)
3. Move to archive location
4. Update archive index
5. Verify archive integrity
6. Remove from active storage

**Archive Script:**
```bash
#!/bin/bash
# Archive old data

SOURCE_DIR="$1"
ARCHIVE_DIR="$2"
DAYS_OLD="${3:-90}"

# Create archive directory
mkdir -p "$ARCHIVE_DIR"

# Find and compress old files
find "$SOURCE_DIR" -type f -mtime +"$DAYS_OLD" ! -name "*.gz" | while read file; do
    # Compress
    gzip "$file"

    # Move to archive
    mv "${file}.gz" "$ARCHIVE_DIR/"

    echo "Archived: $(basename "$file")"
done

# Create archive index
ls -lh "$ARCHIVE_DIR" > "${ARCHIVE_DIR}/archive_index_$(date +%Y%m%d).txt"
```

### Automated Archive Integration

**Self-Maintenance Integration:**
```bash
# In self_maintenance_v1.0.0.sh fix_disk_space()

# Archive old logs
find "${SKIPPY_BASE}/logs" -name "*.log" -mtime +30 ! -name "*.gz" -exec gzip {} \;

# Move to archive
mkdir -p "${SKIPPY_BASE}/logs/archive"
find "${SKIPPY_BASE}/logs" -name "*.gz" -mtime +30 -exec mv {} "${SKIPPY_BASE}/logs/archive/" \;

# Archive old conversations
find "${SKIPPY_BASE}/conversations" -name "*session*.md" -mtime +90 ! -name "*.gz" -exec gzip {} \;
```

---

## Deletion Procedures

### Safe Deletion Checklist

Before deleting data, verify:
- [ ] Data is outside retention period
- [ ] Data has been archived if required
- [ ] No active references to data
- [ ] No legal/compliance hold
- [ ] Backup exists if data is important
- [ ] Deletion is logged

### Deletion Methods

**Secure Deletion (Sensitive Data):**
```bash
# Use shred for sensitive files
shred -vfz -n 3 /path/to/sensitive/file

# Or use srm if available
srm -v /path/to/sensitive/file
```

**Standard Deletion (Non-Sensitive):**
```bash
# Standard deletion
rm /path/to/file

# Bulk deletion with logging
find /path/to/dir -name "*.log" -mtime +90 -delete -print >> /home/dave/skippy/logs/deletion.log
```

**Database Cleanup:**
```bash
# Clean old WordPress transients
wp transient delete --expired

# Clean old revisions (keep last 5)
wp post delete $(wp post list --post_type='revision' --format=ids --posts_per_page=-1 | tr ' ' '\n' | tail -n +6)
```

### Deletion Logging

**Log all deletions:**
```bash
# Deletion log format
echo "[$(date)] DELETED: $FILE_PATH (Reason: $REASON, Age: $AGE days)" >> /home/dave/skippy/logs/deletion.log
```

**Deletion Log Retention:** 1 year

---

## Storage Optimization

### Compression Strategy

**What to Compress:**
- Logs older than 30 days
- Archived reports/transcripts
- Old backups
- Historical metrics

**What NOT to Compress:**
- Active logs (last 7 days)
- Current backups
- Frequently accessed files
- Encrypted files (already compressed)

**Compression Commands:**
```bash
# Compress individual file
gzip /path/to/file

# Compress directory (tar)
tar -czf archive.tar.gz /path/to/directory/

# Compress in place (save space)
find /path -name "*.log" -mtime +30 -exec gzip {} \;
```

### Deduplication

**Backup Deduplication:**
- Use incremental backups where possible
- Deduplicate before archiving
- Consider using dedup-aware backup tools

**Log Deduplication:**
- Aggregate similar log entries
- Compress repeated patterns
- Use log aggregator's built-in dedup

---

## Compliance Considerations

### Legal Requirements

**Campaign Finance Data:**
- **Retention:** Per state/federal law (typically 3-7 years)
- **Storage:** Encrypted, backed up
- **Access:** Restricted, logged

**Volunteer/Supporter PII:**
- **Retention:** Only as long as necessary for purpose
- **Deletion:** Must be deletable on request (GDPR/CCPA)
- **Storage:** Encrypted, access controlled

**Email Communications:**
- **Retention:** Per legal requirements and CAN-SPAM
- **Unsubscribe Records:** Permanent
- **Storage:** Backed up, accessible

### Data Subject Requests

**Right to Access:**
- Provide all data about individual within 30 days
- Include sources, purposes, sharing

**Right to Deletion:**
- Delete personal data upon request
- Some exceptions (legal obligations, public interest)
- Document deletion

**Data Portability:**
- Provide data in machine-readable format
- Within 30 days of request

**Request Process:**
```bash
# Search for individual's data
grep -r "email@example.com" /home/dave/skippy/logs/
find /home/dave/skippy -name "*email*"

# Generate data export
# [Create export package with all relevant data]

# Delete data
# [Remove from all locations, log deletion]
```

---

## Monitoring and Reporting

### Storage Monitoring

**Monitor Daily:**
- Total disk usage
- Growth rate
- Largest directories
- Cleanup effectiveness

**Monitoring Script:**
```bash
#!/bin/bash
# Storage monitoring

SKIPPY_BASE="/home/dave/skippy"

# Total usage
du -sh "$SKIPPY_BASE"

# By directory
du -sh "${SKIPPY_BASE}"/*/ | sort -rh

# Growth rate (compare to yesterday)
TODAY=$(du -s "$SKIPPY_BASE" | awk '{print $1}')
YESTERDAY=$(cat "${SKIPPY_BASE}/.storage_size" 2>/dev/null || echo "$TODAY")
GROWTH=$((TODAY - YESTERDAY))
echo "Growth: ${GROWTH}KB"

# Save today's size
echo "$TODAY" > "${SKIPPY_BASE}/.storage_size"
```

### Monthly Retention Report

**Generate Monthly:**
```markdown
# Data Retention Report - [Month Year]

## Storage Summary
- Total Storage: [Size]
- Growth This Month: [Size]
- Projected 90-day: [Size]

## Retention Actions
- Logs Archived: [Count] files, [Size]
- Logs Deleted: [Count] files, [Size]
- Backups Rotated: [Count] files, [Size]
- Transcripts Compressed: [Count] files

## Compliance
- Data Subject Requests: [Count]
- Deletions Performed: [Count]
- Access Requests: [Count]

## Issues
- [Any retention issues or concerns]

## Recommendations
- [Storage optimization suggestions]
```

---

## Automated Cleanup Schedule

### Daily Cleanup (Automated via Cron)

```bash
# 2 AM daily cleanup
0 2 * * * /home/dave/skippy/scripts/cleanup_work_files.sh >> /home/dave/skippy/logs/cleanup.log 2>&1
```

**Daily Tasks:**
- Clean work/active files >7 days
- Clean temporary files
- Rotate active logs
- Update storage metrics

### Weekly Cleanup (Automated via Self-Maintenance)

```bash
# Sunday 3 AM via self_maintenance
0 3 * * 0 /home/dave/skippy/scripts/automation/self_maintenance_v1.0.0.sh run --auto
```

**Weekly Tasks:**
- Compress logs >30 days
- Clean work/archive files >30 days
- Rotate backups
- Archive old reports
- Update retention reports

### Monthly Cleanup (Manual Review Required)

**Monthly Tasks:**
- Review archived data for deletion
- Clean old uploads (claude/uploads)
- Audit compliance
- Generate retention report
- Optimize storage layout

### Quarterly Cleanup (Manual Review Required)

**Quarterly Tasks:**
- Review archive retention
- Audit legal compliance
- Update retention policies
- Test restore from archives
- Capacity planning review

---

## Integration with Existing Tools

### Self-Maintenance Integration

**Location:** `/home/dave/skippy/scripts/automation/self_maintenance_v1.0.0.sh`

**Enhanced fix_disk_space() function:**
```bash
fix_disk_space() {
    log "Applying data retention policies..."

    # Clean old logs (per retention protocol)
    log "  Cleaning logs older than 60 days..."
    find "${SKIPPY_BASE}/logs" -name "*.log" -mtime +60 -delete 2>/dev/null || true

    # Compress logs 30-60 days old
    log "  Compressing logs 30-60 days old..."
    find "${SKIPPY_BASE}/logs" -name "*.log" -mtime +30 -mtime -60 ! -name "*.gz" -exec gzip {} \; 2>/dev/null || true

    # Clean old backups (keep last 30 days)
    log "  Applying backup retention (30 days)..."
    find "${SKIPPY_BASE}/backups" -name "*.sql" -mtime +30 -delete 2>/dev/null || true
    find "${SKIPPY_BASE}/backups" -name "*.tar.gz" -mtime +30 -delete 2>/dev/null || true

    # Archive old conversations
    log "  Compressing conversations older than 90 days..."
    find "${SKIPPY_BASE}/conversations" -name "*session*.md" -mtime +90 ! -name "*.gz" -exec gzip {} \; 2>/dev/null || true

    # Clean work files
    log "  Cleaning work files..."
    if [ -x "${SKIPPY_BASE}/scripts/cleanup_work_files.sh" ]; then
        "${SKIPPY_BASE}/scripts/cleanup_work_files.sh" 2>/dev/null || true
    fi

    success "Data retention policies applied"
}
```

### Log Aggregator Integration

**Location:** `/home/dave/skippy/scripts/monitoring/log_aggregator_v1.0.0.sh`

**Enhanced rotate command:**
```bash
rotate_logs() {
    log "Rotating logs per retention protocol..."

    # Move old collections to archive (30 days)
    local archive_dir="${AGGREGATED_LOGS}/archive"
    mkdir -p "$archive_dir"

    find "$AGGREGATED_LOGS" -name "collection_*.log" -mtime +30 -exec mv {} "$archive_dir/" \;

    # Compress archived logs
    find "$archive_dir" -name "*.log" -type f ! -name "*.gz" -exec gzip {} \;

    # Delete old archives (90 days)
    find "$archive_dir" -name "*.gz" -mtime +90 -delete

    success "Log rotation complete"
}
```

---

## Emergency Procedures

### Critical Storage Full

**If disk space >95% full:**

**Immediate Actions:**
1. Check what's using space: `du -sh /* | sort -rh | head -10`
2. Emergency cleanup of largest consumers
3. Alert team of storage emergency
4. Temporarily increase storage if possible

**Emergency Cleanup Script:**
```bash
#!/bin/bash
# Emergency storage cleanup

# Clean obvious large files first
find /tmp -type f -size +100M -delete
find /home/dave/skippy/work -type f -mtime +1 -delete
find /home/dave/skippy/logs -name "*.log" -mtime +7 -delete

# Aggressive backup cleanup (keep only last 7 days)
find /home/dave/skippy/backups -type f -mtime +7 -delete

# Clean old compressed files
find /home/dave/skippy -name "*.gz" -mtime +30 -delete

# Report results
df -h
```

### Data Recovery Requests

**If deleted data needs recovery:**

**Within Backup Retention:**
1. Identify backup containing data
2. Verify backup integrity
3. Extract needed data
4. Document recovery action

**Outside Backup Retention:**
1. Check archive locations
2. Check log history
3. Attempt filesystem recovery if recent
4. Document inability to recover if not available

---

## Appendix A: Retention Quick Reference

| Data Type | Active | Archive | Total | Compress | Backup |
|-----------|--------|---------|-------|----------|--------|
| Security Logs | 90d | Permanent | ∞ | 90d | Yes |
| Application Logs | 30d | 60d | 90d | 30d | No |
| System Logs | 30d | 60d | 90d | 30d | No |
| Daily Backups | 7d | 23d | 30d | N/A | N/A |
| Weekly Backups | 28d | 60d | 90d | N/A | N/A |
| Transcripts | 90d | 2yr | 2yr | 90d | Yes |
| Reports | 90d | 1yr | 1yr | 90d | Yes |
| Work Files | 7d | 23d | 30d | No | No |
| Alert History | 90d | 1yr | 1yr | 90d | No |
| Metrics | 30d | 60d | 90d | 30d | No |

---

## Appendix B: Storage Commands

```bash
# Check storage usage
du -sh /home/dave/skippy
df -h /home/dave/skippy

# Find largest directories
du -sh /home/dave/skippy/*/ | sort -rh | head -10

# Find largest files
find /home/dave/skippy -type f -size +100M -exec ls -lh {} \;

# Count files by type
find /home/dave/skippy -name "*.log" | wc -l
find /home/dave/skippy -name "*.gz" | wc -l
find /home/dave/skippy -name "*.tar.gz" | wc -l

# Compression savings
du -sh /home/dave/skippy/logs/
find /home/dave/skippy/logs/ -name "*.log" -exec gzip {} \;
du -sh /home/dave/skippy/logs/

# Archive to external location
tar -czf skippy_archive_$(date +%Y%m%d).tar.gz /home/dave/skippy/archive/
```

---

## Appendix C: Compliance Checklist

### Annual Compliance Review

- [ ] Review all retention periods for legal compliance
- [ ] Audit data subject request handling
- [ ] Verify backup retention meets requirements
- [ ] Check encryption of sensitive data
- [ ] Update privacy policy if needed
- [ ] Review access controls on archived data
- [ ] Test data recovery procedures
- [ ] Document compliance status
- [ ] Address any gaps identified
- [ ] Update retention protocol if needed

---

**Version History:**
- 1.0.0 (2025-11-04): Initial protocol creation
