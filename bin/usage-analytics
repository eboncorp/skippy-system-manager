#!/usr/bin/env python3
"""
Usage Analytics for Skippy Scripts and Tools
Track what's actually being used
"""

import sqlite3
import sys
from datetime import datetime, timedelta
from pathlib import Path

DB_PATH = Path.home() / '.skippy' / 'usage.db'

def init_db():
    """Initialize usage tracking database."""
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()

    c.execute('''
        CREATE TABLE IF NOT EXISTS usage (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            timestamp TEXT,
            resource_type TEXT,
            resource_name TEXT,
            duration_seconds REAL,
            success BOOLEAN
        )
    ''')

    conn.commit()
    conn.close()

def track_usage(resource_type: str, resource_name: str, duration: float = 0, success: bool = True):
    """Record usage of a resource."""
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()

    c.execute('''
        INSERT INTO usage (timestamp, resource_type, resource_name, duration_seconds, success)
        VALUES (?, ?, ?, ?, ?)
    ''', (datetime.now().isoformat(), resource_type, resource_name, duration, success))

    conn.commit()
    conn.close()
    print(f"✅ Tracked: {resource_type}/{resource_name}")

def get_top_resources(resource_type: str = None, days: int = 30, limit: int = 10):
    """Get most used resources."""
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()

    since = (datetime.now() - timedelta(days=days)).isoformat()

    query = '''
        SELECT resource_name, COUNT(*) as usage_count,
               AVG(duration_seconds) as avg_duration,
               SUM(CASE WHEN success THEN 1 ELSE 0 END) * 100.0 / COUNT(*) as success_rate
        FROM usage
        WHERE timestamp > ?
    '''

    if resource_type:
        query += ' AND resource_type = ?'
        c.execute(query + ' GROUP BY resource_name ORDER BY usage_count DESC LIMIT ?',
                 (since, resource_type, limit))
    else:
        c.execute(query + ' GROUP BY resource_name ORDER BY usage_count DESC LIMIT ?',
                 (since, limit))

    results = c.fetchall()
    conn.close()

    return results

def generate_report():
    """Generate usage analytics report."""
    print("═══════════════════════════════════════════════════")
    print("  Usage Analytics Report")
    print("═══════════════════════════════════════════════════")
    print(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
    print("")

    # Top scripts
    print("Top 10 Scripts (Last 30 days):")
    scripts = get_top_resources('script', days=30)
    if scripts:
        for name, count, duration, success_rate in scripts:
            print(f"  {name}: {count} uses, {duration:.1f}s avg, {success_rate:.0f}% success")
    else:
        print("  No data yet")
    print("")

    # Top commands
    print("Top 10 Slash Commands (Last 30 days):")
    commands = get_top_resources('command', days=30)
    if commands:
        for name, count, duration, success_rate in commands:
            print(f"  /{name}: {count} uses")
    else:
        print("  No data yet")
    print("")

    # Overall stats
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT COUNT(*) FROM usage")
    total = c.fetchone()[0]
    conn.close()

    print(f"Total tracked operations: {total}")
    print("")
    print("Start tracking with:")
    print("  usage-analytics track script my_script.sh")

def main():
    """Main execution."""
    init_db()

    if len(sys.argv) < 2:
        generate_report()
        return

    cmd = sys.argv[1]

    if cmd == "track":
        if len(sys.argv) < 4:
            print("Usage: usage-analytics track <type> <name> [duration] [success]")
            sys.exit(1)
        resource_type = sys.argv[2]
        resource_name = sys.argv[3]
        duration = float(sys.argv[4]) if len(sys.argv) > 4 else 0
        success = sys.argv[5].lower() == 'true' if len(sys.argv) > 5 else True
        track_usage(resource_type, resource_name, duration, success)

    elif cmd == "report":
        generate_report()

    else:
        print(f"Unknown command: {cmd}")
        print("Usage: usage-analytics [track|report]")

if __name__ == '__main__':
    main()
