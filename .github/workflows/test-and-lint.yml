name: Test and Lint

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        run: |
          # Install shellcheck
          sudo apt-get update
          sudo apt-get install -y shellcheck

          # Check all shell scripts (exclude backup/legacy files)
          find . -name "*.sh" -type f \
            ! -path "*/legacy*" \
            ! -name "*_backup*" \
            ! -name "*_original*" \
            ! -name "*_bak*" \
            | while read script; do
            echo "Checking: $script"
            shellcheck "$script" || exit 1
          done

  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint

      - name: Run pylint
        run: |
          # Lint Python files (exclude backup/legacy/venv files)
          # Only fail on fatal errors (exit code 1 = fatal, 2 = error, 4 = warning, etc.)
          find . -name "*.py" -type f \
            ! -path "*/.venv/*" \
            ! -path "*/venv/*" \
            ! -path "*/legacy*" \
            ! -path "*/node_modules/*" \
            ! -name "*_backup*" \
            ! -name "*_original*" \
            ! -name "*_bak*" \
            | while read script; do
            echo "Linting: $script"
            # Disable style/convention warnings, allow warnings (exit 0 if no fatal errors)
            pylint --score=no --fail-under=5 \
              --disable=C,R,W0212,W0404,W0613,W0621,W0702,W1203,W1309,W1510,W1514 \
              "$script" || true
          done
          echo "Lint check complete"

  test-suite:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run tests
        run: |
          if [[ -f development/tests/run_tests.sh ]]; then
            bash development/tests/run_tests.sh
          else
            echo "No tests found"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Credential scan
        run: |
          # Search for potential credentials
          if git diff HEAD~1 | grep -iE '(api_key|api-key|apikey|password|secret|token|auth).*=.*["\047][a-zA-Z0-9]{20,}'; then
            echo "❌ Potential credentials detected in commit"
            exit 1
          else
            echo "✅ No credentials detected"
          fi

      - name: Check for sensitive files
        run: |
          # Check for .env files, keys, etc
          SENSITIVE_FILES=$(find . -name ".env*" -o -name "*.pem" -o -name "*.key" -o -name "*credentials*" 2>/dev/null || true)

          if [[ -n "$SENSITIVE_FILES" ]]; then
            echo "⚠️  Sensitive files found:"
            echo "$SENSITIVE_FILES"
            echo "Ensure these are in .gitignore"
          else
            echo "✅ No sensitive files found"
          fi
