#!/bin/bash
# Vulnerability Scanner v1.0.0
# Scans system for known security vulnerabilities
# Part of: Skippy Security Enhancement Project - Phase 1
# Author: Claude (Skippy Enhancement Project)
# Created: 2025-11-04

set -euo pipefail

# Configuration
SKIPPY_BASE="/home/dave/skippy"
LOG_DIR="${SKIPPY_BASE}/logs/security"
REPORT_DIR="${SKIPPY_BASE}/conversations/security_reports"
ERROR_LOG="${SKIPPY_BASE}/conversations/error_logs/$(date +%Y-%m)/$(date +%Y%m%d_%H%M%S)_security_vuln_scan.log"
SCAN_REPORT="${REPORT_DIR}/vulnerability_scan_$(date +%Y%m%d_%H%M%S).md"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ensure directories exist
mkdir -p "$LOG_DIR" "$REPORT_DIR" "$(dirname "$ERROR_LOG")"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_DIR}/scanner.log"
}

# Error logging
log_error() {
    echo "[ERROR] $1" | tee -a "$ERROR_LOG"
}

# Start scan report
cat > "$SCAN_REPORT" <<'EOFHEADER'
# Security Vulnerability Scan Report

**Scan Date:** $(date)
**Scanner Version:** 1.0.0
**System:** $(hostname)

---

## Summary

EOFHEADER

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘   Security Vulnerability Scanner v1.0.0   â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

log "Starting security vulnerability scan"

# Track findings
TOTAL_CRITICAL=0
TOTAL_HIGH=0
TOTAL_MEDIUM=0
TOTAL_LOW=0
TOTAL_INFO=0

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCAN 1: Python Packages (pip)
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[1/8] Scanning Python packages for vulnerabilities...${NC}"

if command -v pip3 &> /dev/null; then
    log "Checking Python packages with pip-audit"

    # Install pip-audit if not present
    if ! command -v pip-audit &> /dev/null; then
        log "Installing pip-audit..."
        pip3 install --user pip-audit >/dev/null 2>&1 || {
            log_error "Failed to install pip-audit"
            echo "âš ï¸  pip-audit not available, skipping Python package scan"
        }
    fi

    if command -v pip-audit &> /dev/null; then
        PYTHON_VULNS=$(pip-audit --format json 2>/dev/null || echo '{"dependencies":[]}')
        PYTHON_COUNT=$(echo "$PYTHON_VULNS" | grep -o '"vulns":' | wc -l || echo "0")

        if [ "$PYTHON_COUNT" -gt 0 ]; then
            echo -e "${RED}âœ— Found $PYTHON_COUNT Python package vulnerabilities${NC}"
            TOTAL_HIGH=$((TOTAL_HIGH + PYTHON_COUNT))

            cat >> "$SCAN_REPORT" <<EOF

### Python Package Vulnerabilities: $PYTHON_COUNT found

\`\`\`json
$PYTHON_VULNS
\`\`\`

EOF
        else
            echo -e "${GREEN}âœ“ No Python package vulnerabilities found${NC}"
        fi
    fi
else
    echo "â„¹ï¸  Python/pip not installed, skipping"
fi

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCAN 2: Node.js Packages (npm)
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[2/8] Scanning Node.js packages for vulnerabilities...${NC}"

if command -v npm &> /dev/null; then
    log "Checking npm packages"

    # Find all package.json files
    PACKAGE_DIRS=$(find "$HOME" -name "package.json" -not -path "*/node_modules/*" -not -path "*/.npm/*" 2>/dev/null)

    if [ -n "$PACKAGE_DIRS" ]; then
        NPM_VULN_COUNT=0
        while IFS= read -r package_json; do
            PKG_DIR=$(dirname "$package_json")
            log "Scanning: $PKG_DIR"

            cd "$PKG_DIR" || continue
            AUDIT_OUTPUT=$(npm audit --json 2>/dev/null || echo '{"metadata":{"vulnerabilities":{"total":0}}}')
            VULN_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.total' 2>/dev/null || echo "0")

            if [ "$VULN_COUNT" -gt 0 ]; then
                echo -e "${RED}âœ— Found $VULN_COUNT vulnerabilities in $PKG_DIR${NC}"
                NPM_VULN_COUNT=$((NPM_VULN_COUNT + VULN_COUNT))

                cat >> "$SCAN_REPORT" <<EOF

### npm Vulnerabilities in $PKG_DIR: $VULN_COUNT found

\`\`\`json
$AUDIT_OUTPUT
\`\`\`

EOF
            fi
        done <<< "$PACKAGE_DIRS"

        if [ "$NPM_VULN_COUNT" -gt 0 ]; then
            echo -e "${RED}âœ— Total npm vulnerabilities: $NPM_VULN_COUNT${NC}"
            TOTAL_HIGH=$((TOTAL_HIGH + NPM_VULN_COUNT))
        else
            echo -e "${GREEN}âœ“ No npm vulnerabilities found${NC}"
        fi
    else
        echo "â„¹ï¸  No Node.js projects found"
    fi
else
    echo "â„¹ï¸  Node.js/npm not installed, skipping"
fi

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCAN 3: System Package Vulnerabilities (apt)
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[3/8] Checking system packages for updates...${NC}"

if command -v apt &> /dev/null; then
    log "Checking apt packages"

    SECURITY_UPDATES=$(apt list --upgradable 2>/dev/null | grep -i security | wc -l || echo "0")

    if [ "$SECURITY_UPDATES" -gt 0 ]; then
        echo -e "${YELLOW}âš  $SECURITY_UPDATES security updates available${NC}"
        TOTAL_MEDIUM=$((TOTAL_MEDIUM + SECURITY_UPDATES))

        cat >> "$SCAN_REPORT" <<EOF

### System Security Updates Available: $SECURITY_UPDATES

\`\`\`
$(apt list --upgradable 2>/dev/null | grep -i security || echo "None")
\`\`\`

**Recommendation:** Run \`sudo apt update && sudo apt upgrade\`

EOF
    else
        echo -e "${GREEN}âœ“ System packages up to date${NC}"
    fi
else
    echo "â„¹ï¸  apt not available, skipping"
fi

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCAN 4: Exposed Secrets in Git History
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[4/8] Scanning git history for exposed secrets...${NC}"

if [ -d "${SKIPPY_BASE}/.git" ]; then
    log "Scanning skippy git history"

    cd "$SKIPPY_BASE" || exit 1

    # Check for common secret patterns in git history
    SECRET_PATTERNS=(
        "password"
        "api[_-]?key"
        "secret"
        "token"
        "bearer"
        "aws[_-]?access"
        "private[_-]?key"
    )

    SECRETS_FOUND=0
    for pattern in "${SECRET_PATTERNS[@]}"; do
        MATCHES=$(git log --all --full-history -S"$pattern" --pretty=format:"%H %s" 2>/dev/null | wc -l || echo "0")
        if [ "$MATCHES" -gt 0 ]; then
            SECRETS_FOUND=$((SECRETS_FOUND + MATCHES))
            echo -e "${YELLOW}  Found $MATCHES commits mentioning '$pattern'${NC}"
        fi
    done

    if [ "$SECRETS_FOUND" -gt 0 ]; then
        echo -e "${YELLOW}âš  Found $SECRETS_FOUND potential secret references in git history${NC}"
        TOTAL_MEDIUM=$((TOTAL_MEDIUM + 1)) # Count as 1 issue, not per match

        cat >> "$SCAN_REPORT" <<EOF

### Potential Secrets in Git History

Found $SECRETS_FOUND references to sensitive keywords in git history.

**Recommendation:** Review git history manually. If secrets are found:
1. Rotate the compromised credentials
2. Use BFG Repo Cleaner or git-filter-branch to remove from history
3. Force push cleaned history (WARNING: destructive)

EOF
    else
        echo -e "${GREEN}âœ“ No obvious secrets in git history${NC}"
    fi
else
    echo "â„¹ï¸  Not a git repository, skipping"
fi

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCAN 5: File Permissions Issues
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[5/8] Checking file permissions...${NC}"

log "Scanning for permission issues"

# Check for world-writable files
WORLD_WRITABLE=$(find "$SKIPPY_BASE" -type f -perm -002 2>/dev/null | wc -l || echo "0")

if [ "$WORLD_WRITABLE" -gt 0 ]; then
    echo -e "${YELLOW}âš  Found $WORLD_WRITABLE world-writable files${NC}"
    TOTAL_LOW=$((TOTAL_LOW + WORLD_WRITABLE))

    cat >> "$SCAN_REPORT" <<EOF

### World-Writable Files: $WORLD_WRITABLE found

\`\`\`
$(find "$SKIPPY_BASE" -type f -perm -002 2>/dev/null | head -20)
\`\`\`

**Recommendation:** Remove write permissions for others: \`chmod o-w <file>\`

EOF
else
    echo -e "${GREEN}âœ“ No world-writable files found${NC}"
fi

# Check for scripts without execute permission
NON_EXEC_SCRIPTS=$(find "$SKIPPY_BASE/scripts" -name "*.sh" ! -perm -u+x 2>/dev/null | wc -l || echo "0")

if [ "$NON_EXEC_SCRIPTS" -gt 0 ]; then
    echo -e "${YELLOW}âš  Found $NON_EXEC_SCRIPTS .sh scripts without execute permission${NC}"
    TOTAL_INFO=$((TOTAL_INFO + NON_EXEC_SCRIPTS))

    cat >> "$SCAN_REPORT" <<EOF

### Scripts Without Execute Permission: $NON_EXEC_SCRIPTS found

\`\`\`
$(find "$SKIPPY_BASE/scripts" -name "*.sh" ! -perm -u+x 2>/dev/null | head -20)
\`\`\`

**Recommendation:** Add execute permission: \`chmod +x <script>\`

EOF
else
    echo -e "${GREEN}âœ“ All shell scripts have execute permission${NC}"
fi

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCAN 6: Hardcoded Credentials in Files
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[6/8] Scanning for hardcoded credentials...${NC}"

log "Scanning for hardcoded credentials"

# Patterns to search for
CRED_PATTERNS=(
    "password\s*=\s*['\"][^'\"]+['\"]"
    "api_key\s*=\s*['\"][^'\"]+['\"]"
    "secret\s*=\s*['\"][^'\"]+['\"]"
    "token\s*=\s*['\"][^'\"]+['\"]"
)

CRED_FILES=0
for pattern in "${CRED_PATTERNS[@]}"; do
    MATCHES=$(grep -r -i -E "$pattern" "$SKIPPY_BASE" \
        --exclude-dir=".git" \
        --exclude-dir="node_modules" \
        --exclude="*.log" \
        --exclude="*.md" 2>/dev/null | wc -l || echo "0")

    if [ "$MATCHES" -gt 0 ]; then
        CRED_FILES=$((CRED_FILES + MATCHES))
    fi
done

if [ "$CRED_FILES" -gt 0 ]; then
    echo -e "${RED}âœ— Found $CRED_FILES potential hardcoded credentials${NC}"
    TOTAL_CRITICAL=$((TOTAL_CRITICAL + 1))

    cat >> "$SCAN_REPORT" <<EOF

### Hardcoded Credentials: $CRED_FILES potential matches

**CRITICAL:** Hardcoded credentials found in files.

**Recommendation:**
1. Move credentials to environment variables or secure vault
2. Use \`.env\` files (add to .gitignore)
3. Rotate any exposed credentials
4. Use secrets management system

EOF
else
    echo -e "${GREEN}âœ“ No obvious hardcoded credentials found${NC}"
fi

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCAN 7: SSL/TLS Certificate Validity
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[7/8] Checking SSL/TLS certificates...${NC}"

log "Checking certificates"

# Check for any SSL certificates in the system
CERTS=$(find "$SKIPPY_BASE" -name "*.crt" -o -name "*.pem" 2>/dev/null)

if [ -n "$CERTS" ]; then
    EXPIRED_CERTS=0
    while IFS= read -r cert; do
        if openssl x509 -checkend 0 -noout -in "$cert" 2>/dev/null; then
            : # Certificate is valid
        else
            EXPIRED_CERTS=$((EXPIRED_CERTS + 1))
            echo -e "${RED}âœ— Expired certificate: $cert${NC}"
        fi
    done <<< "$CERTS"

    if [ "$EXPIRED_CERTS" -gt 0 ]; then
        TOTAL_HIGH=$((TOTAL_HIGH + EXPIRED_CERTS))
        cat >> "$SCAN_REPORT" <<EOF

### Expired SSL Certificates: $EXPIRED_CERTS found

**Recommendation:** Renew expired certificates immediately.

EOF
    else
        echo -e "${GREEN}âœ“ All certificates are valid${NC}"
    fi
else
    echo "â„¹ï¸  No certificates found"
fi

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCAN 8: Docker Security (if applicable)
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo -e "${YELLOW}[8/8] Checking Docker security...${NC}"

if command -v docker &> /dev/null; then
    log "Checking Docker images"

    # Check for images with known vulnerabilities
    DOCKER_IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" 2>/dev/null | wc -l || echo "0")

    if [ "$DOCKER_IMAGES" -gt 0 ]; then
        echo "â„¹ï¸  Found $DOCKER_IMAGES Docker images"

        # If trivy is installed, scan images
        if command -v trivy &> /dev/null; then
            echo "  Scanning with trivy..."
            # This would be expanded in a real implementation
        else
            echo "  â„¹ï¸  Install trivy for Docker image scanning"
        fi
    else
        echo "â„¹ï¸  No Docker images found"
    fi
else
    echo "â„¹ï¸  Docker not installed, skipping"
fi

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GENERATE SUMMARY
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo ""
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${BLUE}         Scan Complete - Summary         ${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

TOTAL_ISSUES=$((TOTAL_CRITICAL + TOTAL_HIGH + TOTAL_MEDIUM + TOTAL_LOW))

echo ""
if [ "$TOTAL_CRITICAL" -gt 0 ]; then
    echo -e "${RED}  CRITICAL: $TOTAL_CRITICAL${NC}"
fi
if [ "$TOTAL_HIGH" -gt 0 ]; then
    echo -e "${RED}  HIGH:     $TOTAL_HIGH${NC}"
fi
if [ "$TOTAL_MEDIUM" -gt 0 ]; then
    echo -e "${YELLOW}  MEDIUM:   $TOTAL_MEDIUM${NC}"
fi
if [ "$TOTAL_LOW" -gt 0 ]; then
    echo -e "${YELLOW}  LOW:      $TOTAL_LOW${NC}"
fi
if [ "$TOTAL_INFO" -gt 0 ]; then
    echo -e "  INFO:     $TOTAL_INFO"
fi
echo ""
echo -e "  TOTAL ISSUES: $TOTAL_ISSUES"
echo ""

# Update report with summary
sed -i "s/^## Summary$/## Summary\n\n**Total Issues Found:** $TOTAL_ISSUES\n- Critical: $TOTAL_CRITICAL\n- High: $TOTAL_HIGH\n- Medium: $TOTAL_MEDIUM\n- Low: $TOTAL_LOW\n- Info: $TOTAL_INFO/" "$SCAN_REPORT"

# Add recommendations section
cat >> "$SCAN_REPORT" <<EOF

---

## Overall Risk Assessment

EOF

if [ "$TOTAL_CRITICAL" -gt 0 ]; then
    cat >> "$SCAN_REPORT" <<EOF
**Risk Level:** ðŸ”´ CRITICAL

Immediate action required. Critical security issues detected that could lead to system compromise.

EOF
elif [ "$TOTAL_HIGH" -gt 0 ]; then
    cat >> "$SCAN_REPORT" <<EOF
**Risk Level:** ðŸŸ  HIGH

Action required soon. High-priority security issues detected.

EOF
elif [ "$TOTAL_MEDIUM" -gt 0 ]; then
    cat >> "$SCAN_REPORT" <<EOF
**Risk Level:** ðŸŸ¡ MEDIUM

Address when convenient. Medium-priority issues that should be resolved.

EOF
else
    cat >> "$SCAN_REPORT" <<EOF
**Risk Level:** ðŸŸ¢ LOW

System appears secure. Only minor or informational issues detected.

EOF
fi

cat >> "$SCAN_REPORT" <<EOF

---

## Next Steps

1. Review this report carefully
2. Prioritize fixing CRITICAL and HIGH issues
3. Schedule fixes for MEDIUM and LOW issues
4. Run this scanner weekly to catch new vulnerabilities
5. Consider implementing secrets management system

---

## Scan Details

- **Scan Duration:** $(date -d @$(($(date +%s) - $(date -d "$(head -1 ${LOG_DIR}/scanner.log | cut -d' ' -f1-2)" +%s))) -u +%M) minutes
- **Scanner Version:** 1.0.0
- **Report Location:** $SCAN_REPORT
- **Log Location:** ${LOG_DIR}/scanner.log

---

*Generated by Skippy Security Vulnerability Scanner*
*Next scan recommended: $(date -d "+7 days" +%Y-%m-%d)*
EOF

echo -e "${GREEN}Report saved to:${NC} $SCAN_REPORT"
echo ""

log "Vulnerability scan complete. Found $TOTAL_ISSUES total issues."

# Exit with appropriate code
if [ "$TOTAL_CRITICAL" -gt 0 ]; then
    exit 2
elif [ "$TOTAL_HIGH" -gt 0 ]; then
    exit 1
else
    exit 0
fi
